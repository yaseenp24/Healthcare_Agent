<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Health Assistant</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; height: 100vh; background: #f7fafc; }
      .app { height: 100vh; display: flex; flex-direction: column; }

      /* Header */
      .header { padding: 16px 20px; border-bottom: 1px solid #e5e7eb; background: #ffffff; }
      .header-inner { width: 100%; max-width: 980px; margin: 0 auto; display: flex; align-items: center; justify-content: center; position: relative; }
      .logo { width: 28px; height: 28px; border-radius: 50%; background: #e6f4ea; display: grid; place-items: center; font-size: 16px; color: #10b981; margin-right: 10px; }
      .title { display: flex; flex-direction: column; text-align: center; }
      .title h1 { margin: 0; font-size: 18px; font-weight: 600; color: #111827; }
      .title small { color: #6b7280; }
      .reset { position: absolute; right: 0; top: 50%; transform: translateY(-50%); padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f3f4f6; color: #111827; cursor: pointer; }

      /* Chat area */
      .chat { flex: 1; display: flex; justify-content: center; overflow: hidden; } 
      .chat-inner { width: 100%; max-width: 980px; padding: 16px; overflow: auto; }     
      .row-msg { display: flex; align-items: flex-end; gap: 8px; margin: 8px 0; }  
      .row-msg.user { justify-content: flex-end; }
      .row-msg.bot { justify-content: flex-start; }
      .avatar { width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center; font-size: 16px; flex: 0 0 28px; }
      .avatar.bot { background: #d1fae5; color: #065f46; }
      .avatar.user { background: #38bdf8; color: #ffffff; }
      .bubble { max-width: 840px; padding: 12px 14px; border-radius: 14px; white-space: pre-wrap; line-height: 1.4; }
      .bubble.user { background: #e8eefc; color: #1f2937; border-top-right-radius: 6px; }
      .bubble.bot { background: #e9f7ef; color: #1f2937; border-top-left-radius: 6px; }
      .bot a { color: #2563eb; text-decoration: underline; }

      /* Input bar */
      .composer { border-top: 1px solid #e5e7eb; background: #ffffff; padding: 12px 16px; display: flex; justify-content: center; }
      .composer-inner { width: 100%; max-width: 980px; display: flex; gap: 10px; } 
      #input { flex: 1; padding: 12px 14px; border-radius: 12px; border: 1px solid #e5e7eb; background: #f9fafb; }
      #sendBtn { padding: 12px 16px; border-radius: 12px; border: 1px solid #38bdf8; background: #38bdf8; color: white; cursor: pointer; }
      #sendBtn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="header-inner">
          <div class="logo">ðŸ’š</div>
          <div class="title">
            <h1>Health Assistant</h1>
            <small>Your trusted AI companion for health guidance</small>
          </div>
          <button id="resetBtn" class="reset" title="Start over">Reset</button>
        </div>
      </div>

      <div class="chat">
        <div id="messages" class="chat-inner" aria-live="polite"></div>
      </div>

      <div class="composer">
        <div class="composer-inner">
          <input id="input" type="text" placeholder="Ask me about your health concerns..." />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>

    <script>
      const messages = document.getElementById('messages');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('sendBtn');
      const resetBtn = document.getElementById('resetBtn');

      function escapeHTML(s) {
        return s.replace(/[&<>"']/g, c => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[c]);
      }

      function linkify(text) {
        const escaped = escapeHTML(text);
        const urlRegex = /(https?:\/\/[\w\-._~:\/?#\[\]@!$&'()*+,;=%]+)/g;
        return escaped.replace(urlRegex, (m) => `<a href="${m}" target="_blank" rel="noopener noreferrer">link</a>`);
      }

      function addMessage(text, who) {
        const row = document.createElement('div');
        row.className = 'row-msg ' + who;
        const avatar = document.createElement('div');
        avatar.className = 'avatar ' + who;
        avatar.textContent = (who === 'bot') ? 'ðŸ¤–' : 'ðŸ‘¤';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + who;
        if (who === 'bot') {
          bubble.innerHTML = linkify(text);
          row.appendChild(avatar);
          row.appendChild(bubble);
        } else {
          bubble.textContent = text;
          row.appendChild(bubble);
          row.appendChild(avatar);
        }
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
      }

      async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        addMessage(text, 'user');
        sendBtn.disabled = true;
        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Request failed');
          addMessage(data.reply, 'bot');
        } catch (err) {
          addMessage('Error: ' + err.message, 'bot');
        } finally {
          sendBtn.disabled = false;
          input.focus();
        }
      }

      // Events
      sendBtn.addEventListener('click', sendMessage);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
      resetBtn.addEventListener('click', async () => {
        await fetch('/api/reset', { method: 'POST' });
        messages.innerHTML = '';
        addGreeting();
        input.focus();
      });

      function addGreeting() {
        if (messages.children.length === 0) {
          addMessage("Hello! I'm your Health Assistant. I'm here to help answer your health-related questions and provide guidance when you're feeling unwell. How can I assist you today?", 'bot');
        }
      }

      // Initial greeting
      addGreeting();
      input.focus();
    </script>
  </body>
</html>
